SELECT 
		ROW_NUMBER() OVER (ORDER BY C.PICKUP_DATE) RECORD_ID, 
		A.REG_NO, C.ORDER_NUMBER, C.CUSTOMER_SID, 
		C.DESCRIPTION, C.ORIGIN_CODE, C.ORIGIN_NAME, 
		C.DESTINATION_CODE, C.DESTINATION_NAME, C.PICKUP_DATE, 
		C.PROGRESS_DATE, C.DELIVERY_DATE, C.ARRIVAL_DATE, 
		C.COMPLETE_DATE, C.DUE_DATE, C.EXPIRED_DATE, 
		C.DRIVER_SID, ISNULL(B.PHONE, '') AS DRIVER_PHONE, 
		C.ROUTE_UID, C.STATUS, C.SWITCH_FROM, 
		CASE WHEN (C.ORDER_NUMBER IS NULL) AND (DATEDIFF(HOUR, A.LAST_UPDATE, GETDATE()) > 24) THEN 'OFGOENSN' 
		WHEN (C.ORDER_NUMBER IS NULL) AND (ISNULL(A.LAST_IO1, 0) = 1) THEN 'OFGUETSN' 
		WHEN (C.ORDER_NUMBER IS NULL) AND (ISNULL(A.LAST_IO1,0) = 0) THEN 'OFGUEFSN' 
		WHEN (C.ORDER_NUMBER IS NOT NULL) AND (DATEDIFF(MINUTE, A.LAST_UPDATE, GETDATE()) > 30) THEN 'OTGDENSN' 
		WHEN (C.ORDER_NUMBER IS NOT NULL) AND (ISNULL(A.LAST_IO1, 0) = 0) AND (DATEDIFF(MINUTE, A.LAST_ENGINE, GETDATE()) > 30) AND (A.POLYGON = '') THEN 'OTGUEOSOVS' 
		WHEN (C.ORDER_NUMBER IS NOT NULL) AND (C.STATUS = 'Kosongan') AND (A.LAST_UPDATE < C.PICKUP_DATE) THEN 'OTGUENSNLD' 
		WHEN (C.ORDER_NUMBER IS NOT NULL) AND (C.STATUS = 'Waiting') AND (A.LAST_UPDATE < C.PICKUP_DATE) THEN 'OTGUENSWTG' 
		WHEN (C.ORDER_NUMBER IS NOT NULL) AND ((C.STATUS = 'OnDelivery' AND (A.LAST_UPDATE < C.DUE_DATE)) OR C.STATUS = 'Arrive') THEN 'OTGUENSOND' 
		WHEN (C.ORDER_NUMBER IS NOT NULL) AND (C.STATUS = 'Overnight') THEN 'OTGUENSOVN' 
		WHEN (C.ORDER_NUMBER IS NOT NULL) AND ((((C.STATUS = 'Kosongan') OR (C.STATUS = 'Waiting')) AND (A.LAST_UPDATE > C.PICKUP_DATE)) OR ((C.STATUS = 'OnDelivery') AND (A.LAST_UPDATE > C.DUE_DATE))) THEN 'OTGUENSABN' 
		ELSE 'OFGOENSN' 
		END AS ORDSTS, 
		CASE WHEN DATEDIFF(HOUR, A.LAST_UPDATE, GETDATE()) > 24 THEN 'INACTIVE' 
		WHEN (DATEDIFF(MINUTE, A.LAST_UPDATE, GETDATE()) > 30) AND (DATEDIFF(HOUR, A.LAST_UPDATE, GETDATE()) <= 24) THEN 'DELAY' 
		WHEN DATEDIFF(MINUTE, A.LAST_UPDATE, GETDATE()) <= 30 THEN 'ACTIVE' 
		END AS GPS, 
		A.VEHICLE_SID, A.LAST_WP_LAT, A.LAST_WP_LON, 
		A.LAST_IO1, A.LAST_WP_SPEED, A.LAST_UPDATE, 
		A.POLYGON, A.HEADING, A.VEHICLE_IMEI, 
		A.WP_PROPINSI, A.WP_KABUPATEN, A.WP_KECAMATAN, 
		A.WP_KELURAHAN, A.WP_JALAN, A.LAST_IO2, 
		A.LAST_IO3, A.LAST_IO4, A.MODEL_UNIT, 
		A.EXT_POWER,ROUND(A.KM_ODO,0) AS KM_ODO, A.CELLNO, 
		A.SUHU01, A.SUHU02, A.LAST_GPS_STATUS,
		(A.WP_JALAN +', '+ A.WP_KELURAHAN +', '+ A.WP_KABUPATEN +', '+ A.WP_PROPINSI) AS LOCATION, 
		F.IO1_Caption, F.IO1_Visible,F.IO1_On_Caption, 
		F.IO1_Off_Caption, F.IO2_Caption, F.IO2_Visible,
		F.IO2_On_Caption, F.IO2_Off_Caption, F.IO3_Caption, 
		F.IO3_Visible,F.IO3_On_Caption, F.IO3_Off_Caption, 
		F.IO4_Caption, F.IO4_Visible,F.IO4_On_Caption, 
		F.IO4_Off_Caption, F.Suhu01_Caption, F.Suhu01_Visible,
		F.Suhu02_Caption, F.Suhu02_Visible 
FROM VEHICLES AS A LEFT JOIN DRIVER AS B ON A.DRIVER_SID = B.DRIVER_SID 
OUTER APPLY( SELECT TOP 1 * FROM DATA_ORDER WHERE REG_NO = A.REG_NO AND STATUS <> 'Completed' ORDER BY PICKUP_DATE DESC ) AS C 
OUTER APPLY( SELECT TOP 1 * FROM PROJECT_VEHICLE WHERE VEHICLE_SID = A.VEHICLE_SID AND STATUS <> 'Completed' ORDER BY STARTDATE DESC ) AS D 
LEFT JOIN CUSTOMER_PROJECT E ON E.PROJECT_SID = D.PROJECT_SID LEFT JOIN VehicleConfig F ON F.VehicleSid = A.VEHICLE_SID
WHERE E.CUSTOMER_SID = @CUSTOMER_SID AND E.PROJECT_SID = @PROJECT_SID 
AND A.IS_ACTIVE = 1